apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sidecar
  namespace: cornserve
  labels:
    app: sidecar
spec:
  serviceName: sidecar
  selector:
    matchLabels:
      app: sidecar
  replicas: 4
  template:
    metadata:
      labels:
        app: sidecar
    spec:
      hostPID: true
      hostIPC: true
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: sidecar
      runtimeClassName: nvidia
      serviceAccountName: sidecar
      containers:
      - name: sidecar
        image: cornserve/sidecar:latest
        imagePullPolicy: Always
        securityContext:
          privileged: true
        env:
          - name: SIDECAR_WORLD_SIZE
            value: "4"
          - name: SIDECAR_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        volumeMounts:
          - name: shm-volume
            mountPath: /dev/shm
          - name: infiniband-class
            mountPath: /sys/class/infiniband
          - name: infiniband-dev
            mountPath: /dev/infiniband
      volumes:
      - name: shm-volume
        hostPath:
          path: /dev/shm
          type: Directory
      - name: infiniband-class
        hostPath:
          path: /sys/class/infiniband
          type: Directory
      - name: infiniband-dev
        hostPath:
          path: /dev/infiniband
          type: Directory
